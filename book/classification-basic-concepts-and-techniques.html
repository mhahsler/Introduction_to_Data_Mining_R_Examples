<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Classification: Basic Concepts and Techniques | An R Companion for Introduction to Data Mining</title>
<meta name="author" content="Michael Hahsler">
<meta name="description" content="Install the packages used in this chapter: pkgs &lt;- sort(c('tidyverse', 'rpart', 'rpart.plot', 'caret',  'lattice', 'FSelector', 'sampling', 'pROC', 'mlbench')) pkgs_install &lt;- pkgs[!(pkgs %in%...">
<meta name="generator" content="bookdown 0.34 with bs4_book()">
<meta property="og:title" content="Chapter 3 Classification: Basic Concepts and Techniques | An R Companion for Introduction to Data Mining">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/cover.png">
<meta property="og:description" content="Install the packages used in this chapter: pkgs &lt;- sort(c('tidyverse', 'rpart', 'rpart.plot', 'caret',  'lattice', 'FSelector', 'sampling', 'pROC', 'mlbench')) pkgs_install &lt;- pkgs[!(pkgs %in%...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 Classification: Basic Concepts and Techniques | An R Companion for Introduction to Data Mining">
<meta name="twitter:description" content="Install the packages used in this chapter: pkgs &lt;- sort(c('tidyverse', 'rpart', 'rpart.plot', 'caret',  'lattice', 'FSelector', 'sampling', 'pROC', 'mlbench')) pkgs_install &lt;- pkgs[!(pkgs %in%...">
<meta name="twitter:image" content="/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap/bootstrap.bundle.min.js"></script><script src="libs/bs3compat/transition.js"></script><script src="libs/bs3compat/tabs.js"></script><script src="libs/bs3compat/bs3compat.js"></script><link href="libs/bs4_book/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book/bs4_book.js"></script><script src="libs/accessible-code-block/empty-anchor.js"></script><script src="libs/htmlwidgets/htmlwidgets.js"></script><script src="libs/plotly-binding/plotly.js"></script><script src="libs/typedarray/typedarray.min.js"></script><link href="libs/crosstalk/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main/plotly-latest.min.js"></script><link href="libs/datatables-css/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding/datatables.js"></script><link href="libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core/js/jquery.dataTables.min.js"></script><link href="libs/nouislider/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider/jquery.nouislider.min.js"></script><link href="libs/selectize/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize/selectize.min.js"></script><link href="libs/vis/vis-network.min.css" rel="stylesheet">
<script src="libs/vis/vis-network.min.js"></script><script src="libs/visNetwork-binding/visNetwork.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">An R Companion for Introduction to Data Mining</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="data.html"><span class="header-section-number">2</span> Data</a></li>
<li><a class="active" href="classification-basic-concepts-and-techniques.html"><span class="header-section-number">3</span> Classification: Basic Concepts and Techniques</a></li>
<li><a class="" href="classification-alternative-techniques.html"><span class="header-section-number">4</span> Classification: Alternative Techniques</a></li>
<li><a class="" href="association-analysis-basic-concepts-and-algorithms.html"><span class="header-section-number">5</span> Association Analysis: Basic Concepts and Algorithms</a></li>
<li><a class="" href="association-analysis-advanced-concepts.html"><span class="header-section-number">6</span> Association Analysis: Advanced Concepts</a></li>
<li><a class="" href="clustering-analysis.html"><span class="header-section-number">7</span> Clustering Analysis</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mhahsler/Introduction_to_Data_Mining_R_Examples">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="classification-basic-concepts-and-techniques" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> Classification: Basic Concepts and Techniques<a class="anchor" aria-label="anchor" href="#classification-basic-concepts-and-techniques"><i class="fas fa-link"></i></a>
</h1>
<p>Install the packages used in this chapter:</p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arules/man/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'tidyverse'</span>, <span class="st">'rpart'</span>, <span class="st">'rpart.plot'</span>, <span class="st">'caret'</span>, </span>
<span>  <span class="st">'lattice'</span>, <span class="st">'FSelector'</span>, <span class="st">'sampling'</span>, <span class="st">'pROC'</span>, <span class="st">'mlbench'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pkgs_install</span> <span class="op">&lt;-</span> <span class="va">pkgs</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="va">pkgs</span> <span class="op"><a href="https://rdrr.io/pkg/arules/man/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,<span class="st">"Package"</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pkgs_install</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="va">pkgs_install</span><span class="op">)</span></span></code></pre></div>
<p>The packages used for this chapter are: <em>caret</em> <span class="citation">(M. Kuhn <a href="references.html#ref-R-caret" role="doc-biblioref">2023</a>)</span>, <em>FSelector</em> <span class="citation">(Romanski, Kotthoff, and Schratz <a href="references.html#ref-R-FSelector" role="doc-biblioref">2021</a>)</span>, <em>lattice</em> <span class="citation">(Sarkar <a href="references.html#ref-R-lattice" role="doc-biblioref">2023</a>)</span>, <em>mlbench</em> <span class="citation">(Leisch and Dimitriadou. <a href="references.html#ref-R-mlbench" role="doc-biblioref">2023</a>)</span>, <em>pROC</em> <span class="citation">(Robin et al. <a href="references.html#ref-R-pROC" role="doc-biblioref">2023</a>)</span>, <em>rpart</em> <span class="citation">(Therneau and Atkinson <a href="references.html#ref-R-rpart" role="doc-biblioref">2022</a>)</span>, <em>rpart.plot</em> <span class="citation">(Milborrow <a href="references.html#ref-R-rpart.plot" role="doc-biblioref">2022</a>)</span>, <em>sampling</em> <span class="citation">(Tillé and Matei <a href="references.html#ref-R-sampling" role="doc-biblioref">2021</a>)</span>, <em>tidyverse</em> <span class="citation">(Wickham <a href="references.html#ref-R-tidyverse" role="doc-biblioref">2023</a><a href="references.html#ref-R-tidyverse" role="doc-biblioref">b</a>)</span></p>
<div id="introduction-2" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-2"><i class="fas fa-link"></i></a>
</h2>
<p>Classification is a machine learning task with the goal to learn a predictive
function of the form</p>
<p><span class="math display">\[y = f(\mathbf{x}),\]</span></p>
<p>where <span class="math inline">\(\mathbf{x}\)</span> is called the attribute set and <span class="math inline">\(y\)</span> the class label. The attribute set
consists of feature which describe an object. These features can be measured using any scale
(i.e., nominal, interval, …). The class label is a nominal attribute. It it is a binary
attribute, then the problem is called a binary classification problem.</p>
<p>Classification learns the classification model from training data where both the features and
the correct class label are available. This is why it is called a <a href="https://en.wikipedia.org/wiki/Supervised_learning">supervised learning problem</a>.</p>
<p>A related supervised learning problem is <a href="https://en.wikipedia.org/wiki/Linear_regression">regression</a>,
where <span class="math inline">\(y\)</span> is a number instead of a label.
Linear regression is a very popular supervised learning model, however, we will not talk about it here
since it is taught in almost any introductory statistics course.</p>
<p>This chapter will introduce decision trees, model evaluation and comparison, feature selection,
and then explore methods to handle the class imbalance problem.</p>
<p>You can read the free sample chapter from the textbook <span class="citation">(Tan, Steinbach, and Kumar <a href="references.html#ref-Tan2005" role="doc-biblioref">2005</a>)</span>:
<a href="https://www-users.cs.umn.edu/~kumar001/dmbook/ch3_classification.pdf">Chapter 3. Classification: Basic Concepts and
Techniques</a></p>
</div>
<div id="the-zoo-dataset" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> The Zoo Dataset<a class="anchor" aria-label="anchor" href="#the-zoo-dataset"><i class="fas fa-link"></i></a>
</h2>
<p>To demonstrate classification, we will use the Zoo dataset which is included in the R package
<strong>mlbench</strong> (you may have to install it). The Zoo dataset containing 17
(mostly logical) variables for 101 animals as a data frame with
17 columns (hair, feathers, eggs, milk, airborne, aquatic, predator,
toothed, backbone, breathes, venomous, fins, legs, tail, domestic,
catsize, type).
The first 16 columns represent the feature vector <span class="math inline">\(\mathbf{x}\)</span> and the last column
called type is the class label <span class="math inline">\(y\)</span>.
We convert the data frame into a tidyverse tibble
(optional).</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Zoo</span>, package<span class="op">=</span><span class="st">"mlbench"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Zoo</span><span class="op">)</span></span></code></pre></div>
<pre><code>##           hair feathers  eggs  milk airborne aquatic
## aardvark  TRUE    FALSE FALSE  TRUE    FALSE   FALSE
## antelope  TRUE    FALSE FALSE  TRUE    FALSE   FALSE
## bass     FALSE    FALSE  TRUE FALSE    FALSE    TRUE
## bear      TRUE    FALSE FALSE  TRUE    FALSE   FALSE
## boar      TRUE    FALSE FALSE  TRUE    FALSE   FALSE
## buffalo   TRUE    FALSE FALSE  TRUE    FALSE   FALSE
##          predator toothed backbone breathes venomous
## aardvark     TRUE    TRUE     TRUE     TRUE    FALSE
## antelope    FALSE    TRUE     TRUE     TRUE    FALSE
## bass         TRUE    TRUE     TRUE    FALSE    FALSE
## bear         TRUE    TRUE     TRUE     TRUE    FALSE
## boar         TRUE    TRUE     TRUE     TRUE    FALSE
## buffalo     FALSE    TRUE     TRUE     TRUE    FALSE
##           fins legs  tail domestic catsize   type
## aardvark FALSE    4 FALSE    FALSE    TRUE mammal
## antelope FALSE    4  TRUE    FALSE    TRUE mammal
## bass      TRUE    0  TRUE    FALSE   FALSE   fish
## bear     FALSE    4 FALSE    FALSE    TRUE mammal
## boar     FALSE    4  TRUE    FALSE    TRUE mammal
## buffalo  FALSE    4  TRUE    FALSE    TRUE mammal</code></pre>
<p><em>Note:</em> data.frames in R can have row names. The Zoo data set uses the
animal name as the row names. tibbles from <code>tidyverse</code> do not support
row names. To keep the animal name you can add a column with the animal
name.</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">Zoo</span>, rownames <span class="op">=</span> <span class="st">"animal"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 101 × 18
##    animal   hair  feathers eggs  milk  airborne aquatic
##    &lt;chr&gt;    &lt;lgl&gt; &lt;lgl&gt;    &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt;    &lt;lgl&gt;  
##  1 aardvark TRUE  FALSE    FALSE TRUE  FALSE    FALSE  
##  2 antelope TRUE  FALSE    FALSE TRUE  FALSE    FALSE  
##  3 bass     FALSE FALSE    TRUE  FALSE FALSE    TRUE   
##  4 bear     TRUE  FALSE    FALSE TRUE  FALSE    FALSE  
##  5 boar     TRUE  FALSE    FALSE TRUE  FALSE    FALSE  
##  6 buffalo  TRUE  FALSE    FALSE TRUE  FALSE    FALSE  
##  7 calf     TRUE  FALSE    FALSE TRUE  FALSE    FALSE  
##  8 carp     FALSE FALSE    TRUE  FALSE FALSE    TRUE   
##  9 catfish  FALSE FALSE    TRUE  FALSE FALSE    TRUE   
## 10 cavy     TRUE  FALSE    FALSE TRUE  FALSE    FALSE  
## # ℹ 91 more rows
## # ℹ 11 more variables: predator &lt;lgl&gt;, toothed &lt;lgl&gt;,
## #   backbone &lt;lgl&gt;, breathes &lt;lgl&gt;, venomous &lt;lgl&gt;,
## #   fins &lt;lgl&gt;, legs &lt;int&gt;, tail &lt;lgl&gt;,
## #   domestic &lt;lgl&gt;, catsize &lt;lgl&gt;, type &lt;fct&gt;</code></pre>
<p>You will have to remove the animal column before learning a model! In
the following I use the data.frame.</p>
<p>I translate all the TRUE/FALSE values into factors (nominal). This is
often needed for building models. Always check <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> to make sure
the data is ready for model learning.</p>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zoo</span> <span class="op">&lt;-</span> <span class="va">Zoo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.logical</span><span class="op">)</span>, <span class="va">factor</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span>, <span class="va">factor</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: There was 1 warning in `mutate()`.
## ℹ In argument: `across(where(is.logical), factor, levels = c(TRUE, FALSE))`.
## Caused by warning:
## ! The `...` argument of `across()` is deprecated as of dplyr 1.1.0.
## Supply arguments directly to `.fns` through an anonymous function instead.
## 
##   # Previously
##   across(a:b, mean, na.rm = TRUE)
## 
##   # Now
##   across(a:b, \(x) mean(x, na.rm = TRUE))</code></pre>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">Zoo</span><span class="op">)</span></span></code></pre></div>
<pre><code>##     hair     feathers     eggs       milk   
##  TRUE :43   TRUE :20   TRUE :59   TRUE :41  
##  FALSE:58   FALSE:81   FALSE:42   FALSE:60  
##                                             
##                                             
##                                             
##                                             
##                                             
##   airborne   aquatic    predator   toothed  
##  TRUE :24   TRUE :36   TRUE :56   TRUE :61  
##  FALSE:77   FALSE:65   FALSE:45   FALSE:40  
##                                             
##                                             
##                                             
##                                             
##                                             
##   backbone   breathes   venomous     fins   
##  TRUE :83   TRUE :80   TRUE : 8   TRUE :17  
##  FALSE:18   FALSE:21   FALSE:93   FALSE:84  
##                                             
##                                             
##                                             
##                                             
##                                             
##       legs         tail     domestic   catsize  
##  Min.   :0.00   TRUE :75   TRUE :13   TRUE :44  
##  1st Qu.:2.00   FALSE:26   FALSE:88   FALSE:57  
##  Median :4.00                                   
##  Mean   :2.84                                   
##  3rd Qu.:4.00                                   
##  Max.   :8.00                                   
##                                                 
##             type   
##  mammal       :41  
##  bird         :20  
##  reptile      : 5  
##  fish         :13  
##  amphibian    : 4  
##  insect       : 8  
##  mollusc.et.al:10</code></pre>
</div>
<div id="decision-trees" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Decision Trees<a class="anchor" aria-label="anchor" href="#decision-trees"><i class="fas fa-link"></i></a>
</h2>
<p>Recursive Partitioning (similar to CART) uses the Gini index to make
splitting decisions and early stopping (pre-pruning).</p>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bethatkinson/rpart">rpart</a></span><span class="op">)</span></span></code></pre></div>
<div id="create-tree-with-default-settings-uses-pre-pruning" class="section level3" number="3.3.1">
<h3>
<span class="header-section-number">3.3.1</span> Create Tree With Default Settings (uses pre-pruning)<a class="anchor" aria-label="anchor" href="#create-tree-with-default-settings-uses-pre-pruning"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_default</span> <span class="op">&lt;-</span> <span class="va">Zoo</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">_</span><span class="op">)</span></span>
<span><span class="va">tree_default</span></span></code></pre></div>
<pre><code>## n= 101 
## 
## node), split, n, loss, yval, (yprob)
##       * denotes terminal node
## 
##  1) root 101 60 mammal (0.41 0.2 0.05 0.13 0.04 0.079 0.099)  
##    2) milk=TRUE 41  0 mammal (1 0 0 0 0 0 0) *
##    3) milk=FALSE 60 40 bird (0 0.33 0.083 0.22 0.067 0.13 0.17)  
##      6) feathers=TRUE 20  0 bird (0 1 0 0 0 0 0) *
##      7) feathers=FALSE 40 27 fish (0 0 0.12 0.33 0.1 0.2 0.25)  
##       14) fins=TRUE 13  0 fish (0 0 0 1 0 0 0) *
##       15) fins=FALSE 27 17 mollusc.et.al (0 0 0.19 0 0.15 0.3 0.37)  
##         30) backbone=TRUE 9  4 reptile (0 0 0.56 0 0.44 0 0) *
##         31) backbone=FALSE 18  8 mollusc.et.al (0 0 0 0 0 0.44 0.56) *</code></pre>
<p><strong>Notes:</strong></p>
<ul>
<li><p><code>|&gt;</code> supplies the data for <code>rpart</code>. Since <code>data</code> is not
the first argument of <code>rpart</code>, the syntax <code>data = _</code> is used to specify
where the data in <code>Zoo</code> goes. The call is equivalent to
<code>tree_default &lt;- rpart(type ~ ., data = Zoo)</code>.</p></li>
<li><p>The formula models the
<code>type</code> variable by all other features is represented by <code>.</code>.</p></li>
<li><p>the class variable needs a factor (nominal) or rpart will create a
regression tree instead of a decision tree. Use <code><a href="https://rdrr.io/r/base/factor.html">as.factor()</a></code> if
necessary.</p></li>
</ul>
<p>Plotting</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.milbo.org/rpart-plot/index.html">rpart.plot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">tree_default</span>, extra <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-101-1.png" width="672"></div>
<p><em>Note:</em> <code>extra=2</code> prints for each leaf node the number of correctly
classified objects from data and the total number of objects from the
training data falling into that node (correct/total).</p>
</div>
<div id="create-a-full-tree" class="section level3" number="3.3.2">
<h3>
<span class="header-section-number">3.3.2</span> Create a Full Tree<a class="anchor" aria-label="anchor" href="#create-a-full-tree"><i class="fas fa-link"></i></a>
</h3>
<p>To create a full tree, we set the complexity parameter cp to 0 (split
even if it does not improve the tree) and we set the minimum number of
observations in a node needed to split to the smallest value of 2 (see:
<code><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">?rpart.control</a></code>). <em>Note:</em> full trees overfit the training data!</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_full</span> <span class="op">&lt;-</span> <span class="va">Zoo</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span> , data <span class="op">=</span> <span class="va">_</span>, </span>
<span>        control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">2</span>, cp <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">tree_full</span>, extra <span class="op">=</span> <span class="fl">2</span>, </span>
<span>           roundint<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>            box.palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Gy"</span>, <span class="st">"Gn"</span>, <span class="st">"Bu"</span>, <span class="st">"Bn"</span>, </span>
<span>                               <span class="st">"Or"</span>, <span class="st">"Rd"</span>, <span class="st">"Pu"</span><span class="op">)</span><span class="op">)</span> <span class="co"># specify 7 colors</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-102-1.png" width="672"></div>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_full</span></span></code></pre></div>
<pre><code>## n= 101 
## 
## node), split, n, loss, yval, (yprob)
##       * denotes terminal node
## 
##   1) root 101 60 mammal (0.41 0.2 0.05 0.13 0.04 0.079 0.099)  
##     2) milk=TRUE 41  0 mammal (1 0 0 0 0 0 0) *
##     3) milk=FALSE 60 40 bird (0 0.33 0.083 0.22 0.067 0.13 0.17)  
##       6) feathers=TRUE 20  0 bird (0 1 0 0 0 0 0) *
##       7) feathers=FALSE 40 27 fish (0 0 0.12 0.33 0.1 0.2 0.25)  
##        14) fins=TRUE 13  0 fish (0 0 0 1 0 0 0) *
##        15) fins=FALSE 27 17 mollusc.et.al (0 0 0.19 0 0.15 0.3 0.37)  
##          30) backbone=TRUE 9  4 reptile (0 0 0.56 0 0.44 0 0)  
##            60) aquatic=FALSE 4  0 reptile (0 0 1 0 0 0 0) *
##            61) aquatic=TRUE 5  1 amphibian (0 0 0.2 0 0.8 0 0)  
##             122) eggs=FALSE 1  0 reptile (0 0 1 0 0 0 0) *
##             123) eggs=TRUE 4  0 amphibian (0 0 0 0 1 0 0) *
##          31) backbone=FALSE 18  8 mollusc.et.al (0 0 0 0 0 0.44 0.56)  
##            62) airborne=TRUE 6  0 insect (0 0 0 0 0 1 0) *
##            63) airborne=FALSE 12  2 mollusc.et.al (0 0 0 0 0 0.17 0.83)  
##             126) predator=FALSE 4  2 insect (0 0 0 0 0 0.5 0.5)  
##               252) legs&gt;=3 2  0 insect (0 0 0 0 0 1 0) *
##               253) legs&lt; 3 2  0 mollusc.et.al (0 0 0 0 0 0 1) *
##             127) predator=TRUE 8  0 mollusc.et.al (0 0 0 0 0 0 1) *</code></pre>
<p>Training error on tree with pre-pruning</p>
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_default</span>, <span class="va">Zoo</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span> <span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##          mammal bird reptile fish amphibian insect
## aardvark      1    0       0    0         0      0
## antelope      1    0       0    0         0      0
## bass          0    0       0    1         0      0
## bear          1    0       0    0         0      0
## boar          1    0       0    0         0      0
## buffalo       1    0       0    0         0      0
##          mollusc.et.al
## aardvark             0
## antelope             0
## bass                 0
## bear                 0
## boar                 0
## buffalo              0</code></pre>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_default</span>, <span class="va">Zoo</span>, type<span class="op">=</span><span class="st">"class"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span></code></pre></div>
<pre><code>## aardvark antelope     bass     bear     boar  buffalo 
##   mammal   mammal     fish   mammal   mammal   mammal 
## 7 Levels: mammal bird reptile fish ... mollusc.et.al</code></pre>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">confusion_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">Zoo</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">confusion_table</span></span></code></pre></div>
<pre><code>##                pred
## type            mammal bird reptile fish amphibian
##   mammal            41    0       0    0         0
##   bird               0   20       0    0         0
##   reptile            0    0       5    0         0
##   fish               0    0       0   13         0
##   amphibian          0    0       4    0         0
##   insect             0    0       0    0         0
##   mollusc.et.al      0    0       0    0         0
##                pred
## type            insect mollusc.et.al
##   mammal             0             0
##   bird               0             0
##   reptile            0             0
##   fish               0             0
##   amphibian          0             0
##   insect             0             8
##   mollusc.et.al      0            10</code></pre>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">correct</span> <span class="op">&lt;-</span> <span class="va">confusion_table</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">correct</span></span></code></pre></div>
<pre><code>## [1] 89</code></pre>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">error</span> <span class="op">&lt;-</span> <span class="va">confusion_table</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">correct</span></span>
<span><span class="va">error</span></span></code></pre></div>
<pre><code>## [1] 12</code></pre>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accuracy</span> <span class="op">&lt;-</span> <span class="va">correct</span> <span class="op">/</span> <span class="op">(</span><span class="va">correct</span> <span class="op">+</span> <span class="va">error</span><span class="op">)</span></span>
<span><span class="va">accuracy</span></span></code></pre></div>
<pre><code>## [1] 0.881</code></pre>
<p>Use a function for accuracy</p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accuracy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">prediction</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">truth</span>, <span class="va">prediction</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">accuracy</span><span class="op">(</span><span class="va">Zoo</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span>, <span class="va">pred</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.881</code></pre>
<p>Training error of the full tree</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">accuracy</span><span class="op">(</span><span class="va">Zoo</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span>, </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_full</span>, <span class="va">Zoo</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Get a confusion table with more statistics (using caret)</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred</span>, </span>
<span>                reference <span class="op">=</span> <span class="va">Zoo</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##                Reference
## Prediction      mammal bird reptile fish amphibian
##   mammal            41    0       0    0         0
##   bird               0   20       0    0         0
##   reptile            0    0       5    0         4
##   fish               0    0       0   13         0
##   amphibian          0    0       0    0         0
##   insect             0    0       0    0         0
##   mollusc.et.al      0    0       0    0         0
##                Reference
## Prediction      insect mollusc.et.al
##   mammal             0             0
##   bird               0             0
##   reptile            0             0
##   fish               0             0
##   amphibian          0             0
##   insect             0             0
##   mollusc.et.al      8            10
## 
## Overall Statistics
##                                         
##                Accuracy : 0.881         
##                  95% CI : (0.802, 0.937)
##     No Information Rate : 0.406         
##     P-Value [Acc &gt; NIR] : &lt;2e-16        
##                                         
##                   Kappa : 0.843         
##                                         
##  Mcnemar's Test P-Value : NA            
## 
## Statistics by Class:
## 
##                      Class: mammal Class: bird
## Sensitivity                  1.000       1.000
## Specificity                  1.000       1.000
## Pos Pred Value               1.000       1.000
## Neg Pred Value               1.000       1.000
## Prevalence                   0.406       0.198
## Detection Rate               0.406       0.198
## Detection Prevalence         0.406       0.198
## Balanced Accuracy            1.000       1.000
##                      Class: reptile Class: fish
## Sensitivity                  1.0000       1.000
## Specificity                  0.9583       1.000
## Pos Pred Value               0.5556       1.000
## Neg Pred Value               1.0000       1.000
## Prevalence                   0.0495       0.129
## Detection Rate               0.0495       0.129
## Detection Prevalence         0.0891       0.129
## Balanced Accuracy            0.9792       1.000
##                      Class: amphibian Class: insect
## Sensitivity                    0.0000        0.0000
## Specificity                    1.0000        1.0000
## Pos Pred Value                    NaN           NaN
## Neg Pred Value                 0.9604        0.9208
## Prevalence                     0.0396        0.0792
## Detection Rate                 0.0000        0.0000
## Detection Prevalence           0.0000        0.0000
## Balanced Accuracy              0.5000        0.5000
##                      Class: mollusc.et.al
## Sensitivity                         1.000
## Specificity                         0.912
## Pos Pred Value                      0.556
## Neg Pred Value                      1.000
## Prevalence                          0.099
## Detection Rate                      0.099
## Detection Prevalence                0.178
## Balanced Accuracy                   0.956</code></pre>
</div>
<div id="make-predictions-for-new-data" class="section level3" number="3.3.3">
<h3>
<span class="header-section-number">3.3.3</span> Make Predictions for New Data<a class="anchor" aria-label="anchor" href="#make-predictions-for-new-data"><i class="fas fa-link"></i></a>
</h3>
<p>Make up my own animal: A lion with feathered wings</p>
<div class="sourceCode" id="cb270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_animal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>hair <span class="op">=</span> <span class="cn">TRUE</span>, feathers <span class="op">=</span> <span class="cn">TRUE</span>, eggs <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  milk <span class="op">=</span> <span class="cn">TRUE</span>, airborne <span class="op">=</span> <span class="cn">TRUE</span>, aquatic <span class="op">=</span> <span class="cn">FALSE</span>, predator <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  toothed <span class="op">=</span> <span class="cn">TRUE</span>, backbone <span class="op">=</span> <span class="cn">TRUE</span>, breathes <span class="op">=</span> <span class="cn">TRUE</span>, venomous <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  fins <span class="op">=</span> <span class="cn">FALSE</span>, legs <span class="op">=</span> <span class="fl">4</span>, tail <span class="op">=</span> <span class="cn">TRUE</span>, domestic <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  catsize <span class="op">=</span> <span class="cn">FALSE</span>, type <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<p>Fix columns to be factors like in the training set.</p>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_animal</span> <span class="op">&lt;-</span> <span class="va">my_animal</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.logical</span><span class="op">)</span>, <span class="va">factor</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">my_animal</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 17
##   hair  feathers eggs  milk  airborne aquatic predator
##   &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;    &lt;fct&gt;   &lt;fct&gt;   
## 1 TRUE  TRUE     FALSE TRUE  TRUE     FALSE   TRUE    
## # ℹ 10 more variables: toothed &lt;fct&gt;, backbone &lt;fct&gt;,
## #   breathes &lt;fct&gt;, venomous &lt;fct&gt;, fins &lt;fct&gt;,
## #   legs &lt;dbl&gt;, tail &lt;fct&gt;, domestic &lt;fct&gt;,
## #   catsize &lt;fct&gt;, type &lt;fct&gt;</code></pre>
<p>Make a prediction using the default tree</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_default</span> , <span class="va">my_animal</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      1 
## mammal 
## 7 Levels: mammal bird reptile fish ... mollusc.et.al</code></pre>
</div>
</div>
<div id="model-evaluation-with-caret" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Model Evaluation with Caret<a class="anchor" aria-label="anchor" href="#model-evaluation-with-caret"><i class="fas fa-link"></i></a>
</h2>
<p>The package <a href="https://topepo.github.io/caret/"><code>caret</code></a> makes preparing
training sets, building classification (and regression) models and
evaluation easier. A great cheat sheet can be found
<a href="https://ugoproto.github.io/ugo_r_doc/pdf/caret.pdf">here</a>.</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span></span></code></pre></div>
<p>Cross-validation runs are independent and can be done faster in
parallel. To enable multi-core support, <code>caret</code> uses the package
<code>foreach</code> and you need to load a <code>do</code> backend. For Linux, you can use
<code>doMC</code> with 4 cores. Windows needs different backend like <code>doParallel</code>
(see <code>caret</code> cheat sheet above).</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Linux backend</span></span>
<span><span class="co"># library(doMC)</span></span>
<span><span class="co"># registerDoMC(cores = 4)</span></span>
<span><span class="co"># getDoParWorkers()</span></span>
<span></span>
<span><span class="co">## Windows backend</span></span>
<span><span class="co"># library(doParallel)</span></span>
<span><span class="co"># cl &lt;- makeCluster(4, type="SOCK")</span></span>
<span><span class="co"># registerDoParallel(cl)</span></span></code></pre></div>
<p>Set random number generator seed to make results reproducible</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2000</span><span class="op">)</span></span></code></pre></div>
<div id="hold-out-test-data" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> Hold out Test Data<a class="anchor" aria-label="anchor" href="#hold-out-test-data"><i class="fas fa-link"></i></a>
</h3>
<p>Test data is not used in the model building process and set aside purely
for testing the model. Here, we partition data the 80% training and 20%
testing.</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html">createDataPartition</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Zoo</span><span class="op">$</span><span class="va">type</span>, p <span class="op">=</span> <span class="fl">.8</span>, list <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">Zoo_train</span> <span class="op">&lt;-</span> <span class="va">Zoo</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">inTrain</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Slicing with a 1-column matrix was deprecated in dplyr 1.1.0.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zoo_test</span> <span class="op">&lt;-</span> <span class="va">Zoo</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="op">-</span><span class="va">inTrain</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="learn-a-model-and-tune-hyperparameters-on-the-training-data" class="section level3" number="3.4.2">
<h3>
<span class="header-section-number">3.4.2</span> Learn a Model and Tune Hyperparameters on the Training Data<a class="anchor" aria-label="anchor" href="#learn-a-model-and-tune-hyperparameters-on-the-training-data"><i class="fas fa-link"></i></a>
</h3>
<p>The package <code>caret</code> combines training and validation for hyperparameter
tuning into a single function called <code><a href="https://rdrr.io/pkg/caret/man/train.html">train()</a></code>. It internally splits the
data into training and validation sets and thus will provide you with
error estimates for different hyperparameter settings. <code>trainControl</code> is
used to choose how testing is performed.</p>
<p>For rpart, train tries to tune the <code>cp</code> parameter (tree complexity)
using accuracy to chose the best model. I set <code>minsplit</code> to 2 since we
have not much data. <strong>Note:</strong> Parameters used for tuning (in this case
<code>cp</code>) need to be set using a data.frame in the argument <code>tuneGrid</code>!
Setting it in control will be ignored.</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="va">_</span> ,</span>
<span>    method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span>, number <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    tuneLength <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span></span></code></pre></div>
<pre><code>## CART 
## 
## 83 samples
## 16 predictors
##  7 classes: 'mammal', 'bird', 'reptile', 'fish', 'amphibian', 'insect', 'mollusc.et.al' 
## 
## No pre-processing
## Resampling: Cross-Validated (10 fold) 
## Summary of sample sizes: 77, 74, 75, 73, 74, 76, ... 
## Resampling results across tuning parameters:
## 
##   cp    Accuracy  Kappa
##   0.00  0.938     0.919
##   0.08  0.897     0.868
##   0.16  0.745     0.664
##   0.22  0.666     0.554
##   0.32  0.474     0.190
## 
## Accuracy was used to select the optimal model
##  using the largest value.
## The final value used for the model was cp = 0.</code></pre>
<p><strong>Note:</strong> Train has built 10 trees using the training folds for each
value of <code>cp</code> and the reported values for accuracy and Kappa are the
averages on the validation folds.</p>
<p>A model using the best tuning parameters and using all the data supplied
to <code><a href="https://rdrr.io/pkg/caret/man/train.html">train()</a></code> is available as <code>fit$finalModel</code>.</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">finalModel</span>, extra <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  box.palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Gy"</span>, <span class="st">"Gn"</span>, <span class="st">"Bu"</span>, <span class="st">"Bn"</span>, <span class="st">"Or"</span>, <span class="st">"Rd"</span>, <span class="st">"Pu"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-115-1.png" width="672"></div>
<p>caret also computes variable importance. By default it uses competing
splits (splits which would be runners up, but do not get chosen by the
tree) for rpart models (see <code><a href="https://rdrr.io/pkg/caret/man/varImp.html">? varImp</a></code>). Toothed is the runner up for
many splits, but it never gets chosen!</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html">varImp</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<pre><code>## rpart variable importance
## 
##               Overall
## toothedFALSE   100.00
## feathersFALSE   69.81
## backboneFALSE   63.08
## milkFALSE       55.56
## eggsFALSE       53.61
## hairFALSE       50.52
## finsFALSE       46.98
## tailFALSE       28.45
## breathesFALSE   28.13
## airborneFALSE   26.27
## legs            25.86
## aquaticFALSE     5.96
## predatorFALSE    2.35
## venomousFALSE    1.39
## catsizeFALSE     0.00
## domesticFALSE    0.00</code></pre>
<p>Here is the variable importance without competing splits.</p>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html">varImp</a></span><span class="op">(</span><span class="va">fit</span>, compete <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">imp</span></span></code></pre></div>
<pre><code>## rpart variable importance
## 
##               Overall
## milkFALSE      100.00
## feathersFALSE   55.69
## finsFALSE       39.45
## toothedFALSE    22.96
## airborneFALSE   22.48
## aquaticFALSE     9.99
## eggsFALSE        6.66
## legs             5.55
## predatorFALSE    1.85
## domesticFALSE    0.00
## breathesFALSE    0.00
## catsizeFALSE     0.00
## tailFALSE        0.00
## hairFALSE        0.00
## backboneFALSE    0.00
## venomousFALSE    0.00</code></pre>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">imp</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-117-1.png" width="672"></div>
<p><strong>Note:</strong> Not all models provide a variable importance function. In this
case caret might calculate the variable importance by itself and ignore
the model (see <code><a href="https://rdrr.io/pkg/caret/man/varImp.html">? varImp</a></code>)!</p>
</div>
</div>
<div id="testing-confusion-matrix-and-confidence-interval-for-accuracy" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Testing: Confusion Matrix and Confidence Interval for Accuracy<a class="anchor" aria-label="anchor" href="#testing-confusion-matrix-and-confidence-interval-for-accuracy"><i class="fas fa-link"></i></a>
</h2>
<p>Use the best model on the test data</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">Zoo_test</span><span class="op">)</span></span>
<span><span class="va">pred</span></span></code></pre></div>
<pre><code>##  [1] mammal        mammal        mollusc.et.al
##  [4] insect        mammal        mammal       
##  [7] mammal        bird          mammal       
## [10] mammal        bird          fish         
## [13] fish          mammal        mollusc.et.al
## [16] bird          insect        bird         
## 7 Levels: mammal bird reptile fish ... mollusc.et.al</code></pre>
<p>Caret’s <code><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix()</a></code> function calculates accuracy, confidence
intervals, kappa and many more evaluation metrics. You need to use
separate test data to create a confusion matrix based on the
generalization error.</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred</span>, </span>
<span>                ref <span class="op">=</span> <span class="va">Zoo_test</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##                Reference
## Prediction      mammal bird reptile fish amphibian
##   mammal             8    0       0    0         0
##   bird               0    4       0    0         0
##   reptile            0    0       0    0         0
##   fish               0    0       0    2         0
##   amphibian          0    0       0    0         0
##   insect             0    0       1    0         0
##   mollusc.et.al      0    0       0    0         0
##                Reference
## Prediction      insect mollusc.et.al
##   mammal             0             0
##   bird               0             0
##   reptile            0             0
##   fish               0             0
##   amphibian          0             0
##   insect             1             0
##   mollusc.et.al      0             2
## 
## Overall Statistics
##                                         
##                Accuracy : 0.944         
##                  95% CI : (0.727, 0.999)
##     No Information Rate : 0.444         
##     P-Value [Acc &gt; NIR] : 1.08e-05      
##                                         
##                   Kappa : 0.923         
##                                         
##  Mcnemar's Test P-Value : NA            
## 
## Statistics by Class:
## 
##                      Class: mammal Class: bird
## Sensitivity                  1.000       1.000
## Specificity                  1.000       1.000
## Pos Pred Value               1.000       1.000
## Neg Pred Value               1.000       1.000
## Prevalence                   0.444       0.222
## Detection Rate               0.444       0.222
## Detection Prevalence         0.444       0.222
## Balanced Accuracy            1.000       1.000
##                      Class: reptile Class: fish
## Sensitivity                  0.0000       1.000
## Specificity                  1.0000       1.000
## Pos Pred Value                  NaN       1.000
## Neg Pred Value               0.9444       1.000
## Prevalence                   0.0556       0.111
## Detection Rate               0.0000       0.111
## Detection Prevalence         0.0000       0.111
## Balanced Accuracy            0.5000       1.000
##                      Class: amphibian Class: insect
## Sensitivity                        NA        1.0000
## Specificity                         1        0.9412
## Pos Pred Value                     NA        0.5000
## Neg Pred Value                     NA        1.0000
## Prevalence                          0        0.0556
## Detection Rate                      0        0.0556
## Detection Prevalence                0        0.1111
## Balanced Accuracy                  NA        0.9706
##                      Class: mollusc.et.al
## Sensitivity                         1.000
## Specificity                         1.000
## Pos Pred Value                      1.000
## Neg Pred Value                      1.000
## Prevalence                          0.111
## Detection Rate                      0.111
## Detection Prevalence                0.111
## Balanced Accuracy                   1.000</code></pre>
<p><strong>Some notes</strong></p>
<ul>
<li>Many classification algorithms and <code>train</code> in caret do not deal well
with missing values. If your classification model can deal with
missing values (e.g., <code>rpart</code>) then use <code>na.action = na.pass</code> when
you call <code>train</code> and <code>predict</code>. Otherwise, you need to remove
observations with missing values with <code>na.omit</code> or use imputation to
replace the missing values before you train the model. Make sure
that you still have enough observations left.</li>
<li>Make sure that nominal variables (this includes logical variables)
are coded as factors.</li>
<li>The class variable for train in caret cannot have level names that
are keywords in R (e.g., <code>TRUE</code> and <code>FALSE</code>). Rename them to, for
example, “yes” and “no.”</li>
<li>Make sure that nominal variables (factors) have examples for all
possible values. Some methods might have problems with variable
values without examples. You can drop empty levels using
<code>droplevels</code> or <code>factor</code>.</li>
<li>Sampling in train might create a sample that does not contain
examples for all values in a nominal (factor) variable. You will get
an error message. This most likely happens for variables which have
one very rare value. You may have to remove the variable.</li>
</ul>
</div>
<div id="model-comparison" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> Model Comparison<a class="anchor" aria-label="anchor" href="#model-comparison"><i class="fas fa-link"></i></a>
</h2>
<p>We will compare decision trees with a k-nearest neighbors (kNN)
classifier. We will create fixed sampling scheme (10-folds) so we
compare the different models using exactly the same folds. It is
specified as <code>trControl</code> during training.</p>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html">createFolds</a></span><span class="op">(</span><span class="va">Zoo_train</span><span class="op">$</span><span class="va">type</span>, k <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Build models</p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rpartFit</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>        tuneLength <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span>, indexOut <span class="op">=</span> <span class="va">train_index</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><strong>Note:</strong> for kNN we ask <code>train</code> to scale the data using
<code>preProcess = "scale"</code>. Logicals will be used as 0-1 variables in
Euclidean distance calculation.</p>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knnFit</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"knn"</span>,</span>
<span>        preProcess <span class="op">=</span> <span class="st">"scale"</span>,</span>
<span>          tuneLength <span class="op">=</span> <span class="fl">10</span>,</span>
<span>          trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span>, indexOut <span class="op">=</span> <span class="va">train_index</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Compare accuracy over all folds.</p>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resamps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/resamples.html">resamples</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        CART <span class="op">=</span> <span class="va">rpartFit</span>,</span>
<span>        kNearestNeighbors <span class="op">=</span> <span class="va">knnFit</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">resamps</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## summary.resamples(object = resamps)
## 
## Models: CART, kNearestNeighbors 
## Number of resamples: 10 
## 
## Accuracy 
##                    Min. 1st Qu. Median  Mean 3rd Qu.
## CART              0.667   0.875  0.889 0.872   0.889
## kNearestNeighbors 0.875   0.917  1.000 0.965   1.000
##                   Max. NA's
## CART                 1    0
## kNearestNeighbors    1    0
## 
## Kappa 
##                    Min. 1st Qu. Median  Mean 3rd Qu.
## CART              0.591   0.833  0.847 0.834   0.857
## kNearestNeighbors 0.833   0.898  1.000 0.955   1.000
##                   Max. NA's
## CART                 1    0
## kNearestNeighbors    1    0</code></pre>
<p><code>caret</code> provides some visualizations using the package <code>lattice</code>. For
example, a boxplot to compare the accuracy and kappa distribution (over
the 10 folds).</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/">lattice</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html">bwplot</a></span><span class="op">(</span><span class="va">resamps</span>, layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-124-1.png" width="672"></div>
<p>We see that kNN is performing consistently better on the folds than CART
(except for some outlier folds).</p>
<p>Find out if one models is statistically better than the other (is the
difference in accuracy is not zero).</p>
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">difs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">resamps</span><span class="op">)</span></span>
<span><span class="va">difs</span></span></code></pre></div>
<pre><code>## 
## Call:
## diff.resamples(x = resamps)
## 
## Models: CART, kNearestNeighbors 
## Metrics: Accuracy, Kappa 
## Number of differences: 1 
## p-value adjustment: bonferroni</code></pre>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">difs</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## summary.diff.resamples(object = difs)
## 
## p-value adjustment: bonferroni 
## Upper diagonal: estimates of the difference
## Lower diagonal: p-value for H0: difference = 0
## 
## Accuracy 
##                   CART   kNearestNeighbors
## CART                     -0.0931          
## kNearestNeighbors 0.0115                  
## 
## Kappa 
##                   CART   kNearestNeighbors
## CART                     -0.121           
## kNearestNeighbors 0.0104</code></pre>
<p>p-values tells you the probability of seeing an even more extreme value
(difference between accuracy) given that the null hypothesis (difference
= 0) is true. For a better classifier, the p-value should be less than
.05 or 0.01. <code>diff</code> automatically applies Bonferroni correction for
multiple comparisons. In this case, kNN seems better but the classifiers
do not perform statistically differently.</p>
</div>
<div id="feature-selection-and-feature-preparation" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> Feature Selection and Feature Preparation<a class="anchor" aria-label="anchor" href="#feature-selection-and-feature-preparation"><i class="fas fa-link"></i></a>
</h2>
<p>Decision trees implicitly select features for splitting, but we can also
select features manually.</p>
<div class="sourceCode" id="cb303"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/larskotthoff/fselector">FSelector</a></span><span class="op">)</span></span></code></pre></div>
<p>see:
<a href="http://en.wikibooks.org/wiki/Data_Mining_Algorithms_In_R/Dimensionality_Reduction/Feature_Selection#The_Feature_Ranking_Approach" class="uri">http://en.wikibooks.org/wiki/Data_Mining_Algorithms_In_R/Dimensionality_Reduction/Feature_Selection#The_Feature_Ranking_Approach</a></p>
<div id="univariate-feature-importance-score" class="section level3" number="3.7.1">
<h3>
<span class="header-section-number">3.7.1</span> Univariate Feature Importance Score<a class="anchor" aria-label="anchor" href="#univariate-feature-importance-score"><i class="fas fa-link"></i></a>
</h3>
<p>These scores measure how related each feature is to the class variable.
For discrete features (as in our case), the chi-square statistic can be
used to derive a score.</p>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/FSelector/man/chi.squared.html">chi.squared</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">_</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">attr_importance</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weights</span></span></code></pre></div>
<pre><code>## # A tibble: 16 × 2
##    feature  attr_importance
##    &lt;chr&gt;              &lt;dbl&gt;
##  1 feathers           1    
##  2 milk               1    
##  3 backbone           1    
##  4 toothed            0.975
##  5 eggs               0.933
##  6 hair               0.907
##  7 breathes           0.898
##  8 airborne           0.848
##  9 fins               0.845
## 10 legs               0.828
## 11 tail               0.779
## 12 catsize            0.664
## 13 aquatic            0.655
## 14 venomous           0.475
## 15 predator           0.385
## 16 domestic           0.231</code></pre>
<p>plot importance in descending order (using <code>reorder</code> to order factor
levels used by <code>ggplot</code>).</p>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">weights</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">attr_importance</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">feature</span>, <span class="va">attr_importance</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Importance score"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Feature"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-128-1.png" width="672"></div>
<p>Get the 5 best features</p>
<div class="sourceCode" id="cb307"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FSelector/man/cutoff.html">cutoff.k</a></span><span class="op">(</span><span class="va">weights</span> <span class="op">|&gt;</span> </span>
<span>                   <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">column_to_rownames</a></span><span class="op">(</span><span class="st">"feature"</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">subset</span></span></code></pre></div>
<pre><code>## [1] "feathers" "milk"     "backbone" "toothed" 
## [5] "eggs"</code></pre>
<p>Use only the best 5 features to build a model (<code>Fselector</code> provides
<code>as.simple.formula</code>)</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FSelector/man/as.simple.formula.html">as.simple.formula</a></span><span class="op">(</span><span class="va">subset</span>, <span class="st">"type"</span><span class="op">)</span></span>
<span><span class="va">f</span></span></code></pre></div>
<pre><code>## type ~ feathers + milk + backbone + toothed + eggs
## &lt;environment: 0x55a5094da288&gt;</code></pre>
<div class="sourceCode" id="cb311"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">_</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">m</span>, extra <span class="op">=</span> <span class="fl">2</span>, roundint <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-130-1.png" width="672"></div>
<p>There are many alternative ways to calculate univariate importance
scores (see package FSelector). Some of them (also) work for continuous
features. One example is the information gain ratio based on entropy as
used in decision tree induction.</p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/FSelector/man/information.gain.html">gain.ratio</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">_</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">attr_importance</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 16 × 2
##    feature  attr_importance
##    &lt;chr&gt;              &lt;dbl&gt;
##  1 milk              1     
##  2 backbone          1     
##  3 feathers          1     
##  4 toothed           0.919 
##  5 eggs              0.827 
##  6 breathes          0.821 
##  7 hair              0.782 
##  8 fins              0.689 
##  9 legs              0.682 
## 10 airborne          0.671 
## 11 tail              0.573 
## 12 aquatic           0.391 
## 13 catsize           0.383 
## 14 venomous          0.351 
## 15 predator          0.125 
## 16 domestic          0.0975</code></pre>
</div>
<div id="feature-subset-selection" class="section level3" number="3.7.2">
<h3>
<span class="header-section-number">3.7.2</span> Feature Subset Selection<a class="anchor" aria-label="anchor" href="#feature-subset-selection"><i class="fas fa-link"></i></a>
</h3>
<p>Often features are related and calculating importance for each feature
independently is not optimal. We can use greedy search heuristics. For
example <code>cfs</code> uses correlation/entropy with best first search.</p>
<div class="sourceCode" id="cb314"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/FSelector/man/cfs.html">cfs</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">_</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "hair"     "feathers" "eggs"     "milk"    
##  [5] "toothed"  "backbone" "breathes" "fins"    
##  [9] "legs"     "tail"</code></pre>
<p>Black-box feature selection uses an evaluator function (the black box)
to calculate a score to be maximized. First, we define an evaluation
function that builds a model given a subset of features and calculates a
quality score. We use here the average for 5 bootstrap samples
(<code>method = "cv"</code> can also be used instead), no tuning (to be faster),
and the average accuracy as the score.</p>
<div class="sourceCode" id="cb316"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evaluator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">subset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/FSelector/man/as.simple.formula.html">as.simple.formula</a></span><span class="op">(</span><span class="va">subset</span>, <span class="st">"type"</span><span class="op">)</span>,</span>
<span>          data <span class="op">=</span> <span class="va">_</span>,</span>
<span>          method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>          trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"boot"</span>, number <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>          tuneLength <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="va">resample</span><span class="op">$</span><span class="va">Accuracy</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Trying features:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">subset</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Accuracy:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="va">m</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Start with all features (but not the class variable <code>type</code>)</p>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">features</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="st">"type"</span><span class="op">)</span></span></code></pre></div>
<p>There are several (greedy) search strategies available. These run for a
while!</p>
<div class="sourceCode" id="cb318"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##subset &lt;- backward.search(features, evaluator)</span></span>
<span><span class="co">##subset &lt;- forward.search(features, evaluator)</span></span>
<span><span class="co">##subset &lt;- best.first.search(features, evaluator)</span></span>
<span><span class="co">##subset &lt;- hill.climbing.search(features, evaluator)</span></span>
<span><span class="co">##subset</span></span></code></pre></div>
</div>
<div id="using-dummy-variables-for-factors" class="section level3" number="3.7.3">
<h3>
<span class="header-section-number">3.7.3</span> Using Dummy Variables for Factors<a class="anchor" aria-label="anchor" href="#using-dummy-variables-for-factors"><i class="fas fa-link"></i></a>
</h3>
<p>Nominal features (factors) are often encoded as a series of 0-1 dummy
variables. For example, let us try to predict if an animal is a predator
given the type. First we use the original encoding of type as a factor
with several values.</p>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_predator</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">predator</span> <span class="op">~</span> <span class="va">type</span>, data <span class="op">=</span> <span class="va">_</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">tree_predator</span>, extra <span class="op">=</span> <span class="fl">2</span>, roundint <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-136-1.png" width="672"></div>
<p><strong>Note:</strong> Some splits use multiple values. Building the tree will become
extremely slow if a factor has many levels (different values) since the
tree has to check all possible splits into two subsets. This situation
should be avoided.</p>
<p>Convert type into a set of 0-1 dummy variables using <code>class2ind</code>. See
also <code><a href="https://rdrr.io/pkg/caret/man/dummyVars.html">? dummyVars</a></code> in package <code>caret</code>.</p>
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zoo_train_dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/dummyVars.html">class2ind</a></span><span class="op">(</span><span class="va">Zoo_train</span><span class="op">$</span><span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_column.html">add_column</a></span><span class="op">(</span>predator <span class="op">=</span> <span class="va">Zoo_train</span><span class="op">$</span><span class="va">predator</span><span class="op">)</span></span>
<span><span class="va">Zoo_train_dummy</span></span></code></pre></div>
<pre><code>## # A tibble: 83 × 8
##    mammal bird  reptile fish  amphibian insect
##    &lt;fct&gt;  &lt;fct&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt; 
##  1 1      0     0       0     0         0     
##  2 1      0     0       0     0         0     
##  3 0      0     0       1     0         0     
##  4 1      0     0       0     0         0     
##  5 1      0     0       0     0         0     
##  6 1      0     0       0     0         0     
##  7 0      0     0       1     0         0     
##  8 0      0     0       1     0         0     
##  9 1      0     0       0     0         0     
## 10 0      1     0       0     0         0     
## # ℹ 73 more rows
## # ℹ 2 more variables: mollusc.et.al &lt;fct&gt;,
## #   predator &lt;fct&gt;</code></pre>
<div class="sourceCode" id="cb322"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_predator</span> <span class="op">&lt;-</span> <span class="va">Zoo_train_dummy</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">predator</span> <span class="op">~</span> <span class="va">.</span>, </span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">2</span>, cp <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">tree_predator</span>, roundint <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-137-1.png" width="672"></div>
<p>Using <code>caret</code> on the original factor encoding automatically translates
factors (here type) into 0-1 dummy variables (e.g., <code>typeinsect = 0</code>).
The reason is that some models cannot directly use factors and <code>caret</code>
tries to consistently work with all of them.</p>
<div class="sourceCode" id="cb323"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">Zoo_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">predator</span> <span class="op">~</span> <span class="va">type</span>, </span>
<span>        data <span class="op">=</span> <span class="va">_</span>, </span>
<span>        method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>        control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        tuneGrid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>cp <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span></span></code></pre></div>
<pre><code>## CART 
## 
## 83 samples
##  1 predictor
##  2 classes: 'TRUE', 'FALSE' 
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 83, 83, 83, 83, 83, 83, ... 
## Resampling results:
## 
##   Accuracy  Kappa
##   0.606     0.203
## 
## Tuning parameter 'cp' was held constant at a value
##  of 0.01</code></pre>
<div class="sourceCode" id="cb325"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">finalModel</span>, extra <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-138-1.png" width="672"></div>
<p><em>Note:</em> To use a fixed value for the tuning parameter <code>cp</code>, we have to
create a tuning grid that only contains that value.</p>
</div>
</div>
<div id="class-imbalance" class="section level2" number="3.8">
<h2>
<span class="header-section-number">3.8</span> Class Imbalance<a class="anchor" aria-label="anchor" href="#class-imbalance"><i class="fas fa-link"></i></a>
</h2>
<p>Classifiers have a hard time to learn from data where we have much more
observations for one class (called the majority class). This is called
the class imbalance problem.</p>
<p>Here is a very good <a href="http://www.kdnuggets.com/2016/08/learning-from-imbalanced-classes.html">article about the problem and
solutions.</a></p>
<div class="sourceCode" id="cb326"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bethatkinson/rpart">rpart</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.milbo.org/rpart-plot/index.html">rpart.plot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Zoo</span>, package<span class="op">=</span><span class="st">"mlbench"</span><span class="op">)</span></span></code></pre></div>
<p>Class distribution</p>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Zoo</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-140-1.png" width="672"></div>
<p>To create an imbalanced problem, we want to decide if an animal is an
reptile. First, we change the class variable to make it into a binary
reptile/no reptile classification problem. <strong>Note:</strong> We use here the
training data for testing. You should use a separate testing data set!</p>
<div class="sourceCode" id="cb328"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zoo_reptile</span> <span class="op">&lt;-</span> <span class="va">Zoo</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Zoo</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"reptile"</span>, </span>
<span>                       levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nonreptile"</span>, <span class="st">"reptile"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Do not forget to make the class variable a factor (a nominal variable)
or you will get a regression tree instead of a classification tree.</p>
<div class="sourceCode" id="cb329"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">Zoo_reptile</span><span class="op">)</span></span></code></pre></div>
<pre><code>##     hair          feathers          eggs        
##  Mode :logical   Mode :logical   Mode :logical  
##  FALSE:58        FALSE:81        FALSE:42       
##  TRUE :43        TRUE :20        TRUE :59       
##                                                 
##                                                 
##                                                 
##     milk          airborne        aquatic       
##  Mode :logical   Mode :logical   Mode :logical  
##  FALSE:60        FALSE:77        FALSE:65       
##  TRUE :41        TRUE :24        TRUE :36       
##                                                 
##                                                 
##                                                 
##   predator        toothed         backbone      
##  Mode :logical   Mode :logical   Mode :logical  
##  FALSE:45        FALSE:40        FALSE:18       
##  TRUE :56        TRUE :61        TRUE :83       
##                                                 
##                                                 
##                                                 
##   breathes        venomous          fins        
##  Mode :logical   Mode :logical   Mode :logical  
##  FALSE:21        FALSE:93        FALSE:84       
##  TRUE :80        TRUE :8         TRUE :17       
##                                                 
##                                                 
##                                                 
##       legs         tail          domestic      
##  Min.   :0.00   Mode :logical   Mode :logical  
##  1st Qu.:2.00   FALSE:26        FALSE:88       
##  Median :4.00   TRUE :75        TRUE :13       
##  Mean   :2.84                                  
##  3rd Qu.:4.00                                  
##  Max.   :8.00                                  
##   catsize                type   
##  Mode :logical   nonreptile:96  
##  FALSE:57        reptile   : 5  
##  TRUE :44                       
##                                 
##                                 
## </code></pre>
<p>See if we have a class imbalance problem.</p>
<div class="sourceCode" id="cb331"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Zoo_reptile</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-143-1.png" width="672"></div>
<p>Create test and training data. I use here a 50/50 split to make sure
that the test set has some samples of the rare reptile class.</p>
<div class="sourceCode" id="cb332"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="va">inTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html">createDataPartition</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Zoo_reptile</span><span class="op">$</span><span class="va">type</span>, p <span class="op">=</span> <span class="fl">.5</span>, list <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">training_reptile</span> <span class="op">&lt;-</span> <span class="va">Zoo_reptile</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">inTrain</span><span class="op">)</span></span>
<span><span class="va">testing_reptile</span> <span class="op">&lt;-</span> <span class="va">Zoo_reptile</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="op">-</span><span class="va">inTrain</span><span class="op">)</span></span></code></pre></div>
<p>the new class variable is clearly not balanced. This is a problem for
building a tree!</p>
<div id="option-1-use-the-data-as-is-and-hope-for-the-best" class="section level3" number="3.8.1">
<h3>
<span class="header-section-number">3.8.1</span> Option 1: Use the Data As Is and Hope For The Best<a class="anchor" aria-label="anchor" href="#option-1-use-the-data-as-is-and-hope-for-the-best"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">training_reptile</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>        trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning in nominalTrainWorkflow(x = x, y = y, wts =
## weights, info = trainInfo, : There were missing values
## in resampled performance measures.</code></pre>
<p><strong>Warnings:</strong> “There were missing values in resampled performance
measures.” means that some test folds did not contain examples of both
classes. This is very likely with class imbalance and small datasets.</p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span></span></code></pre></div>
<pre><code>## CART 
## 
## 51 samples
## 16 predictors
##  2 classes: 'nonreptile', 'reptile' 
## 
## No pre-processing
## Resampling: Cross-Validated (10 fold) 
## Summary of sample sizes: 46, 47, 46, 46, 45, 46, ... 
## Resampling results:
## 
##   Accuracy  Kappa
##   0.947     0    
## 
## Tuning parameter 'cp' was held constant at a value of 0</code></pre>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">finalModel</span>, extra <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-146-1.png" width="672"></div>
<p>the tree predicts everything as non-reptile. Have a look at the error on
the test set.</p>
<div class="sourceCode" id="cb338"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">testing_reptile</span><span class="op">)</span>,</span>
<span>                ref <span class="op">=</span> <span class="va">testing_reptile</span><span class="op">$</span><span class="va">type</span>, positive <span class="op">=</span> <span class="st">"reptile"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   nonreptile reptile
##   nonreptile         48       2
##   reptile             0       0
##                                         
##                Accuracy : 0.96          
##                  95% CI : (0.863, 0.995)
##     No Information Rate : 0.96          
##     P-Value [Acc &gt; NIR] : 0.677         
##                                         
##                   Kappa : 0             
##                                         
##  Mcnemar's Test P-Value : 0.480         
##                                         
##             Sensitivity : 0.00          
##             Specificity : 1.00          
##          Pos Pred Value :  NaN          
##          Neg Pred Value : 0.96          
##              Prevalence : 0.04          
##          Detection Rate : 0.00          
##    Detection Prevalence : 0.00          
##       Balanced Accuracy : 0.50          
##                                         
##        'Positive' Class : reptile       
## </code></pre>
<p>Accuracy is high, but it is exactly the same as the no-information rate
and kappa is zero. Sensitivity is also zero, meaning that we do not
identify any positive (reptile). If the cost of missing a positive is
much larger than the cost associated with misclassifying a negative,
then accuracy is not a good measure! By dealing with imbalance, we are
<strong>not</strong> concerned with accuracy, but we want to increase the
sensitivity, i.e., the chance to identify positive examples.</p>
<p><strong>Note:</strong> The positive class value (the one that you want to detect) is
set manually to reptile using <code>positive = "reptile"</code>. Otherwise
sensitivity/specificity will not be correctly calculated.</p>
</div>
<div id="option-2-balance-data-with-resampling" class="section level3" number="3.8.2">
<h3>
<span class="header-section-number">3.8.2</span> Option 2: Balance Data With Resampling<a class="anchor" aria-label="anchor" href="#option-2-balance-data-with-resampling"><i class="fas fa-link"></i></a>
</h3>
<p>We use stratified sampling with replacement (to oversample the
minority/positive class). You could also use SMOTE (in package <strong>DMwR</strong>)
or other sampling strategies (e.g., from package <strong>unbalanced</strong>). We use
50+50 observations here (<strong>Note:</strong> many samples will be chosen several
times).</p>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">sampling</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span> <span class="co"># for repeatability</span></span>
<span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sampling/man/strata.html">strata</a></span><span class="op">(</span><span class="va">training_reptile</span>, stratanames <span class="op">=</span> <span class="st">"type"</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"srswr"</span><span class="op">)</span></span>
<span><span class="va">training_reptile_balanced</span> <span class="op">&lt;-</span> <span class="va">training_reptile</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">id</span><span class="op">$</span><span class="va">ID_unit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">training_reptile_balanced</span><span class="op">$</span><span class="va">type</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## nonreptile    reptile 
##         50         50</code></pre>
<div class="sourceCode" id="cb342"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">training_reptile_balanced</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>        trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span><span class="op">)</span>,</span>
<span>        control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span></span></code></pre></div>
<pre><code>## CART 
## 
## 100 samples
##  16 predictor
##   2 classes: 'nonreptile', 'reptile' 
## 
## No pre-processing
## Resampling: Cross-Validated (10 fold) 
## Summary of sample sizes: 90, 90, 90, 90, 90, 90, ... 
## Resampling results across tuning parameters:
## 
##   cp    Accuracy  Kappa
##   0.18  0.81      0.62 
##   0.30  0.63      0.26 
##   0.34  0.53      0.06 
## 
## Accuracy was used to select the optimal model
##  using the largest value.
## The final value used for the model was cp = 0.18.</code></pre>
<div class="sourceCode" id="cb344"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">finalModel</span>, extra <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-148-1.png" width="672"></div>
<p>Check on the unbalanced testing data.</p>
<div class="sourceCode" id="cb345"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">testing_reptile</span><span class="op">)</span>,</span>
<span>                ref <span class="op">=</span> <span class="va">testing_reptile</span><span class="op">$</span><span class="va">type</span>, positive <span class="op">=</span> <span class="st">"reptile"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   nonreptile reptile
##   nonreptile         19       0
##   reptile            29       2
##                                         
##                Accuracy : 0.42          
##                  95% CI : (0.282, 0.568)
##     No Information Rate : 0.96          
##     P-Value [Acc &gt; NIR] : 1             
##                                         
##                   Kappa : 0.05          
##                                         
##  Mcnemar's Test P-Value : 2e-07         
##                                         
##             Sensitivity : 1.0000        
##             Specificity : 0.3958        
##          Pos Pred Value : 0.0645        
##          Neg Pred Value : 1.0000        
##              Prevalence : 0.0400        
##          Detection Rate : 0.0400        
##    Detection Prevalence : 0.6200        
##       Balanced Accuracy : 0.6979        
##                                         
##        'Positive' Class : reptile       
## </code></pre>
<p><strong>Note</strong> that the accuracy is below the no information rate! However,
kappa (improvement of accuracy over randomness) and sensitivity (the
ability to identify reptiles) have increased.</p>
<p>There is a tradeoff between sensitivity and specificity (how many of the
identified animals are really reptiles) The tradeoff can be controlled
using the sample proportions. We can sample more reptiles to increase
sensitivity at the cost of lower specificity (this effect cannot be seen
in the data since the test set has only a few reptiles).</p>
<div class="sourceCode" id="cb347"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sampling/man/strata.html">strata</a></span><span class="op">(</span><span class="va">training_reptile</span>, stratanames <span class="op">=</span> <span class="st">"type"</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"srswr"</span><span class="op">)</span></span>
<span><span class="va">training_reptile_balanced</span> <span class="op">&lt;-</span> <span class="va">training_reptile</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">id</span><span class="op">$</span><span class="va">ID_unit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">training_reptile_balanced</span><span class="op">$</span><span class="va">type</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## nonreptile    reptile 
##         50        100</code></pre>
<div class="sourceCode" id="cb349"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">training_reptile_balanced</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>        trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span><span class="op">)</span>,</span>
<span>        control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">testing_reptile</span><span class="op">)</span>,</span>
<span>                ref <span class="op">=</span> <span class="va">testing_reptile</span><span class="op">$</span><span class="va">type</span>, positive <span class="op">=</span> <span class="st">"reptile"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   nonreptile reptile
##   nonreptile         33       0
##   reptile            15       2
##                                         
##                Accuracy : 0.7           
##                  95% CI : (0.554, 0.821)
##     No Information Rate : 0.96          
##     P-Value [Acc &gt; NIR] : 1.000000      
##                                         
##                   Kappa : 0.15          
##                                         
##  Mcnemar's Test P-Value : 0.000301      
##                                         
##             Sensitivity : 1.000         
##             Specificity : 0.688         
##          Pos Pred Value : 0.118         
##          Neg Pred Value : 1.000         
##              Prevalence : 0.040         
##          Detection Rate : 0.040         
##    Detection Prevalence : 0.340         
##       Balanced Accuracy : 0.844         
##                                         
##        'Positive' Class : reptile       
## </code></pre>
</div>
<div id="option-3-build-a-larger-tree-and-use-predicted-probabilities" class="section level3" number="3.8.3">
<h3>
<span class="header-section-number">3.8.3</span> Option 3: Build A Larger Tree and use Predicted Probabilities<a class="anchor" aria-label="anchor" href="#option-3-build-a-larger-tree-and-use-predicted-probabilities"><i class="fas fa-link"></i></a>
</h3>
<p>Increase complexity and require less data for splitting a node. Here I
also use AUC (area under the ROC) as the tuning metric. You need to
specify the two class summary function. Note that the tree still trying
to improve accuracy on the data and not AUC! I also enable class
probabilities since I want to predict probabilities later.</p>
<div class="sourceCode" id="cb351"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">training_reptile</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>        tuneLength <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span>,</span>
<span>        classProbs <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co">## necessary for predict with type="prob"</span></span>
<span>        summaryFunction<span class="op">=</span><span class="va">twoClassSummary</span><span class="op">)</span>,  <span class="co">## necessary for ROC</span></span>
<span>        metric <span class="op">=</span> <span class="st">"ROC"</span>,</span>
<span>        control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning in nominalTrainWorkflow(x = x, y = y, wts =
## weights, info = trainInfo, : There were missing values
## in resampled performance measures.</code></pre>
<div class="sourceCode" id="cb353"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span></span></code></pre></div>
<pre><code>## CART 
## 
## 51 samples
## 16 predictors
##  2 classes: 'nonreptile', 'reptile' 
## 
## No pre-processing
## Resampling: Cross-Validated (10 fold) 
## Summary of sample sizes: 46, 47, 46, 46, 46, 45, ... 
## Resampling results:
## 
##   ROC    Sens   Spec
##   0.358  0.975  0   
## 
## Tuning parameter 'cp' was held constant at a value of 0</code></pre>
<div class="sourceCode" id="cb355"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">finalModel</span>, extra <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-151-1.png" width="672"></div>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">testing_reptile</span><span class="op">)</span>,</span>
<span>                ref <span class="op">=</span> <span class="va">testing_reptile</span><span class="op">$</span><span class="va">type</span>, positive <span class="op">=</span> <span class="st">"reptile"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   nonreptile reptile
##   nonreptile         48       2
##   reptile             0       0
##                                         
##                Accuracy : 0.96          
##                  95% CI : (0.863, 0.995)
##     No Information Rate : 0.96          
##     P-Value [Acc &gt; NIR] : 0.677         
##                                         
##                   Kappa : 0             
##                                         
##  Mcnemar's Test P-Value : 0.480         
##                                         
##             Sensitivity : 0.00          
##             Specificity : 1.00          
##          Pos Pred Value :  NaN          
##          Neg Pred Value : 0.96          
##              Prevalence : 0.04          
##          Detection Rate : 0.00          
##    Detection Prevalence : 0.00          
##       Balanced Accuracy : 0.50          
##                                         
##        'Positive' Class : reptile       
## </code></pre>
<p><strong>Note:</strong> Accuracy is high, but it is close or below to the
no-information rate!</p>
<div id="create-a-biased-classifier" class="section level4" number="3.8.3.1">
<h4>
<span class="header-section-number">3.8.3.1</span> Create A Biased Classifier<a class="anchor" aria-label="anchor" href="#create-a-biased-classifier"><i class="fas fa-link"></i></a>
</h4>
<p>We can create a classifier which will detect more reptiles at the
expense of misclassifying non-reptiles. This is equivalent to increasing
the cost of misclassifying a reptile as a non-reptile. The usual rule is
to predict in each node the majority class from the test data in the
node. For a binary classification problem that means a probability of
&gt;50%. In the following, we reduce this threshold to 1% or more. This
means that if the new observation ends up in a leaf node with 1% or more
reptiles from training then the observation will be classified as a
reptile. The data set is small and this works better with more data.</p>
<div class="sourceCode" id="cb358"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">testing_reptile</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      nonreptile reptile
## tuna      1.000  0.0000
## vole      0.962  0.0385
## wasp      0.500  0.5000
## wolf      0.962  0.0385
## worm      1.000  0.0000
## wren      0.962  0.0385</code></pre>
<div class="sourceCode" id="cb360"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">prob</span><span class="op">[</span>,<span class="st">"reptile"</span><span class="op">]</span><span class="op">&gt;=</span><span class="fl">0.01</span>, <span class="st">"reptile"</span>, <span class="st">"nonreptile"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred</span>,</span>
<span>                ref <span class="op">=</span> <span class="va">testing_reptile</span><span class="op">$</span><span class="va">type</span>, positive <span class="op">=</span> <span class="st">"reptile"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   nonreptile reptile
##   nonreptile         13       0
##   reptile            35       2
##                                         
##                Accuracy : 0.3           
##                  95% CI : (0.179, 0.446)
##     No Information Rate : 0.96          
##     P-Value [Acc &gt; NIR] : 1             
##                                         
##                   Kappa : 0.029         
##                                         
##  Mcnemar's Test P-Value : 9.08e-09      
##                                         
##             Sensitivity : 1.0000        
##             Specificity : 0.2708        
##          Pos Pred Value : 0.0541        
##          Neg Pred Value : 1.0000        
##              Prevalence : 0.0400        
##          Detection Rate : 0.0400        
##    Detection Prevalence : 0.7400        
##       Balanced Accuracy : 0.6354        
##                                         
##        'Positive' Class : reptile       
## </code></pre>
<p><strong>Note</strong> that accuracy goes down and is below the no information rate.
However, both measures are based on the idea that all errors have the
same cost. What is important is that we are now able to find more
reptiles.</p>
</div>
<div id="plot-the-roc-curve" class="section level4" number="3.8.3.2">
<h4>
<span class="header-section-number">3.8.3.2</span> Plot the ROC Curve<a class="anchor" aria-label="anchor" href="#plot-the-roc-curve"><i class="fas fa-link"></i></a>
</h4>
<p>Since we have a binary classification problem and a classifier that
predicts a probability for an observation to be a reptile, we can also
use a <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">receiver operating characteristic
(ROC)</a>
curve. For the ROC curve all different cutoff thresholds for the
probability are used and then connected with a line. The area under the
curve represents a single number for how well the classifier works (the
closer to one, the better).</p>
<div class="sourceCode" id="cb362"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://expasy.org/tools/pROC/">"pROC"</a></span><span class="op">)</span></span></code></pre></div>
<pre><code>## Type 'citation("pROC")' for a citation.</code></pre>
<pre><code>## 
## Attaching package: 'pROC'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     cov, smooth, var</code></pre>
<div class="sourceCode" id="cb366"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span><span class="op">(</span><span class="va">testing_reptile</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"reptile"</span>, <span class="va">prob</span><span class="op">[</span>,<span class="st">"reptile"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Setting levels: control = FALSE, case = TRUE</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span></span></code></pre></div>
<pre><code>## 
## Call:
## roc.default(response = testing_reptile$type == "reptile", predictor = prob[,     "reptile"])
## 
## Data: prob[, "reptile"] in 48 controls (testing_reptile$type == "reptile" FALSE) &lt; 2 cases (testing_reptile$type == "reptile" TRUE).
## Area under the curve: 0.766</code></pre>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/pROC/man/ggroc.html">ggroc</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">1</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-153-1.png" width="672"></div>
</div>
</div>
<div id="option-4-use-a-cost-sensitive-classifier" class="section level3" number="3.8.4">
<h3>
<span class="header-section-number">3.8.4</span> Option 4: Use a Cost-Sensitive Classifier<a class="anchor" aria-label="anchor" href="#option-4-use-a-cost-sensitive-classifier"><i class="fas fa-link"></i></a>
</h3>
<p>The implementation of CART in <code>rpart</code> can use a cost matrix for making
splitting decisions (as parameter <code>loss</code>). The matrix has the form</p>
<p>TP FP FN TN</p>
<p>TP and TN have to be 0. We make FN very expensive (100).</p>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cost</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">0</span>,   <span class="fl">1</span>,</span>
<span>  <span class="fl">100</span>, <span class="fl">0</span></span>
<span><span class="op">)</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">cost</span></span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    0    1
## [2,]  100    0</code></pre>
<div class="sourceCode" id="cb374"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">training_reptile</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">type</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>        data <span class="op">=</span> <span class="va">_</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"rpart"</span>,</span>
<span>        parms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">cost</span><span class="op">)</span>,</span>
<span>        trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cv"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The warning “There were missing values in resampled performance
measures” means that some folds did not contain any reptiles (because of
the class imbalance) and thus the performance measures could not be
calculates.</p>
<div class="sourceCode" id="cb375"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span></span></code></pre></div>
<pre><code>## CART 
## 
## 51 samples
## 16 predictors
##  2 classes: 'nonreptile', 'reptile' 
## 
## No pre-processing
## Resampling: Cross-Validated (10 fold) 
## Summary of sample sizes: 46, 46, 46, 45, 46, 45, ... 
## Resampling results:
## 
##   Accuracy  Kappa  
##   0.477     -0.0304
## 
## Tuning parameter 'cp' was held constant at a value of 0</code></pre>
<div class="sourceCode" id="cb377"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">finalModel</span>, extra <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="R-Companion-Data-Mining_files/figure-html/unnamed-chunk-155-1.png" width="672"></div>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">testing_reptile</span><span class="op">)</span>,</span>
<span>                ref <span class="op">=</span> <span class="va">testing_reptile</span><span class="op">$</span><span class="va">type</span>, positive <span class="op">=</span> <span class="st">"reptile"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   nonreptile reptile
##   nonreptile         39       0
##   reptile             9       2
##                                         
##                Accuracy : 0.82          
##                  95% CI : (0.686, 0.914)
##     No Information Rate : 0.96          
##     P-Value [Acc &gt; NIR] : 0.99998       
##                                         
##                   Kappa : 0.257         
##                                         
##  Mcnemar's Test P-Value : 0.00766       
##                                         
##             Sensitivity : 1.000         
##             Specificity : 0.812         
##          Pos Pred Value : 0.182         
##          Neg Pred Value : 1.000         
##              Prevalence : 0.040         
##          Detection Rate : 0.040         
##    Detection Prevalence : 0.220         
##       Balanced Accuracy : 0.906         
##                                         
##        'Positive' Class : reptile       
## </code></pre>
<p>The high cost for false negatives results in a classifier that does not
miss any reptile.</p>
<p><strong>Note:</strong> Using a cost-sensitive classifier is often the best option.
Unfortunately, the most classification algorithms (or their
implementation) do not have the ability to consider misclassification
cost.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="data.html"><span class="header-section-number">2</span> Data</a></div>
<div class="next"><a href="classification-alternative-techniques.html"><span class="header-section-number">4</span> Classification: Alternative Techniques</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#classification-basic-concepts-and-techniques"><span class="header-section-number">3</span> Classification: Basic Concepts and Techniques</a></li>
<li><a class="nav-link" href="#introduction-2"><span class="header-section-number">3.1</span> Introduction</a></li>
<li><a class="nav-link" href="#the-zoo-dataset"><span class="header-section-number">3.2</span> The Zoo Dataset</a></li>
<li>
<a class="nav-link" href="#decision-trees"><span class="header-section-number">3.3</span> Decision Trees</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#create-tree-with-default-settings-uses-pre-pruning"><span class="header-section-number">3.3.1</span> Create Tree With Default Settings (uses pre-pruning)</a></li>
<li><a class="nav-link" href="#create-a-full-tree"><span class="header-section-number">3.3.2</span> Create a Full Tree</a></li>
<li><a class="nav-link" href="#make-predictions-for-new-data"><span class="header-section-number">3.3.3</span> Make Predictions for New Data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#model-evaluation-with-caret"><span class="header-section-number">3.4</span> Model Evaluation with Caret</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#hold-out-test-data"><span class="header-section-number">3.4.1</span> Hold out Test Data</a></li>
<li><a class="nav-link" href="#learn-a-model-and-tune-hyperparameters-on-the-training-data"><span class="header-section-number">3.4.2</span> Learn a Model and Tune Hyperparameters on the Training Data</a></li>
</ul>
</li>
<li><a class="nav-link" href="#testing-confusion-matrix-and-confidence-interval-for-accuracy"><span class="header-section-number">3.5</span> Testing: Confusion Matrix and Confidence Interval for Accuracy</a></li>
<li><a class="nav-link" href="#model-comparison"><span class="header-section-number">3.6</span> Model Comparison</a></li>
<li>
<a class="nav-link" href="#feature-selection-and-feature-preparation"><span class="header-section-number">3.7</span> Feature Selection and Feature Preparation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#univariate-feature-importance-score"><span class="header-section-number">3.7.1</span> Univariate Feature Importance Score</a></li>
<li><a class="nav-link" href="#feature-subset-selection"><span class="header-section-number">3.7.2</span> Feature Subset Selection</a></li>
<li><a class="nav-link" href="#using-dummy-variables-for-factors"><span class="header-section-number">3.7.3</span> Using Dummy Variables for Factors</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#class-imbalance"><span class="header-section-number">3.8</span> Class Imbalance</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#option-1-use-the-data-as-is-and-hope-for-the-best"><span class="header-section-number">3.8.1</span> Option 1: Use the Data As Is and Hope For The Best</a></li>
<li><a class="nav-link" href="#option-2-balance-data-with-resampling"><span class="header-section-number">3.8.2</span> Option 2: Balance Data With Resampling</a></li>
<li><a class="nav-link" href="#option-3-build-a-larger-tree-and-use-predicted-probabilities"><span class="header-section-number">3.8.3</span> Option 3: Build A Larger Tree and use Predicted Probabilities</a></li>
<li><a class="nav-link" href="#option-4-use-a-cost-sensitive-classifier"><span class="header-section-number">3.8.4</span> Option 4: Use a Cost-Sensitive Classifier</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mhahsler/Introduction_to_Data_Mining_R_Examples/blob/master/book_src/03_classification_basics.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mhahsler/Introduction_to_Data_Mining_R_Examples/edit/master/book_src/03_classification_basics.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>An R Companion for Introduction to Data Mining</strong>" was written by Michael Hahsler. It was last built on 2023-08-31.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
